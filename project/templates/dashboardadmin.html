{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load l10n %}

{% block title %}Admin Dashboard - Marketplace Mahasiswa{% endblock %}

{% block nav_dashboardadmin_active %}current-list-item{% endblock %}


{% block extra_head %}
<style>
  .page-title {
    font-family: "Poppins", sans-serif;
    font-weight: 700;
    font-size: 36px;
    color: #2c2c7c;
    margin-bottom: 25px;
  }
  .section-title-small {
    font-family: "Poppins", sans-serif;
    font-weight: 600;
    font-size: 22px;
    color: #2c2c7c;
    margin-bottom: 15px;
  }
  .badge-status {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: #fff;
  }
  .badge-published { background: #28a745; }
  .badge-unpublished { background: #6c757d; }
  .badge-takedown { background: #dc3545; }

  .badge-selesai { background: #28a745; }
  .badge-menunggu { background: #ffc107; }
  .badge-dibatalkan { background: #dc3545; }

  .btn-dashboard {
    border-radius: 20px;
    font-size: 14px;
    padding: 6px 14px;
    font-weight: 600;
    
  }
  .table-dashboard th,
  .table-dashboard td {
    padding: 10px 5px !important;
    white-space: normal;
    word-wrap: break-word;
    vertical-align: middle !important;
  }
  .table-dashboard img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
  }
  .card-summary {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0px 4px 15px rgba(0,0,0,0.06);
    margin-bottom: 25px;
  }
  .card-summary h2 {
    font-size: 30px;
    margin: 5px 0 10px 0;
    color: #2c2c7c;
  }
  .card-summary p {
    margin: 0;
    color: #777;
  }

  /* biar modal tetap cakep walau theme fruitkha */
  .modal-title {
    font-family: "Poppins", sans-serif;
    font-weight: 700;
    color: #2c2c7c;
  }
  .form-help {
    font-size: 13px;
    color: #666;
    margin-top: 6px;
  }
</style>
{% endblock %}

{% block content %}
<!-- BREADCRUMB -->
<div class="breadcrumb-section breadcrumb-bg">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 offset-lg-2 text-center">
        <div class="breadcrumb-text">
          <p>Panel Admin</p>
          <h1>Admin Dashboard</h1>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RINGKASAN -->
<div class="cart-section mt-150 mb-100">
  <div class="container">
    <div class="row mb-4">
      <div class="col-lg-12">
        <h1 class="page-title">Ringkasan Marketplace</h1>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-3 col-md-6">
        <div class="card-summary text-center">
          <p>Total Listing</p>
          <h2>245</h2>
          <p>Semua jasa yang diupload seller.</p>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card-summary text-center">
          <p>Listing Aktif</p>
          <h2>210</h2>
          <p>Tampil di halaman Produk Jasa.</p>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card-summary text-center">
          <p>Listing Ditakedown</p>
          <h2>15</h2>
          <p>Melanggar atau terindikasi penipuan.</p>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card-summary text-center">
          <p>Pengguna</p>
          <h2>530</h2>
          <p>Seller & customer terdaftar.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 1. KELOLA LISTING JASA -->
<div class="cart-section mb-100">
  <div class="container">

    <div class="row mb-3">
      <div class="col-lg-12">
        <h2 class="section-title-small" id="listing-title">Kelola Listing Jasa</h2>
        <p style="margin-bottom:0;color:#666;">
          Admin bisa <b>edit</b> informasi listing, mengubah <b>status publish</b>, dan melakukan <b>take down</b> jika melanggar aturan.
        </p>
      </div>
    </div>

    <div class="cart-table-wrap">
      <table class="table table-dashboard">
        <thead style="background:#f6f6f6;">
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Seller</th>
            <th>Price</th>
            <th>Rating</th>
            <th>Status</th>
            <th style="min-width:250px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for jasa in list_jasa %}
          <!-- LISTING 1 -->
          <tr id="listing-{{ jasa.id_jasa }}">
            <td><img src="{% static '{{ jasa.image }}' %}" alt=""/></td>
            <td>{{ jasa.name_jasa }}</td>
            <td>{{ jasa.vendor_id_vendor.nama }}</td>
            <td>Rp {{jasa.harga}}</td>
            <td>{{ jasa.rating }}</td>
            <td><span id="badge-jasa-{{ jasa.id_jasa }}" class="badge-status 
              {% if jasa.status == 'Published'%} badge-published
              {% elif jasa.status == 'Unpublished'%} badge-unpublished 
              {% else %} badge-takedown {% endif %}">
              {{ jasa.status }}</span></td>
            <td id="actions-cell-{{ jasa.id_jasa }}">
              <!-- EDIT -> modal -->
              <button
                type="button"
                class="btn btn-primary btn-dashboard js-edit-listing"
                data-toggle="modal"
                data-target="#modalEditListing"
                data-id="{{ jasa.id_jasa }}"
                data-name="{{ jasa.name_jasa }}"
                data-seller="{{ jasa.vendor_id_vendor.nama }}"
                data-price="{{ jasa.harga|unlocalize }}"
                data-status="{{ jasa.status }}"
                data-deskripsi="{{ jasa.deskripsi }}"
              >
                Edit
              </button>

              {% if jasa.status == 'Published' or jasa.status == "Taken Down" %}
                <button type="button" 
                        class="btn btn-warning btn-dashboard js-jasa-status"
                        data-url="{% url 'update_status_jasa' %}"
                        data-id="{{ jasa.id_jasa }}"
                        data-status="Unpublished">
                    Unpublish
                </button>
              {% else %}
                  <button type="button" 
                          class="btn btn-success btn-dashboard js-jasa-status"
                          data-url="{% url 'update_status_jasa' %}"
                          data-id="{{ jasa.id_jasa }}"
                          data-status="Published">
                      Publish
                  </button>
              {% endif %}

              <button 
                type="button"
                class="btn btn-danger btn-dashboard js-takedown"
                data-toggle="modal"
                data-target="#modalTakeDown"
                data-id="{{ jasa.id_jasa }}"
                data-name="{{ jasa.name_jasa }}"
                data-url="{% url 'update_status_jasa' %}"
                data-seller="{{ jasa.vendor_id_vendor.nama }}"
                data-status="Taken Down"
                {% if jasa.status == 'Taken Down' %} disabled {% endif %}
              >
                Take Down 
              </button>
            </td>
          </tr>
          {% endfor %}
         
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- 2. KELOLA USER -->
<div class="cart-section mb-100" style="background:#f8f8f8;">
  <div class="container">

    <h2 class="section-title-small mb-4">Kelola User</h2>
    <p style="color:#666;margin-top:-10px;">
      Admin bisa melihat detail user, mengubah status (aktif/suspend/blokir), dan memantau aktivitas dasar.
    </p>

    <h5 class="mb-3">Seller</h5>
    <div class="cart-table-wrap mb-5">
      <table class="table table-dashboard">
        <thead style="background:#f6f6f6;">
          <tr>
            <th>Nama</th>
            <th>Email</th>
            <th>Jumlah Listing</th>
            <th>Status</th>
            <th style="min-width:260px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for vendor in list_vendor %}
          <tr>
            <td>{{ vendor.nama }}</td>
            <td>{{ vendor.email }}</td>
            <td>{{ vendor.jumlah_jasa }}</td>
            <td>
              <span id="badge-vendor-{{ vendor.id_vendor }}" class="badge-status 
                  {% if vendor.status == 'Aktif' and not vendor.is_deleted %} badge-published
                  {% elif vendor.status == 'Diblokir' and not vendor.is_deleted %} badge-unpublished 
                  {% else %} badge-takedown {% endif %}">
                  {% if vendor.is_deleted %} Dihapus 
                  {% else %} {{ vendor.status }}
                  {% endif %}
              </span>
            </td>
            <td>
              <button
                type="button"
                class="btn btn-primary btn-dashboard btn-detail js-user-detail"
                data-toggle="modal"
                data-target="#modalUserDetail"
                data-role="Vendor"
                data-id="{{ vendor.id_vendor }}"
                data-name="{{ vendor.nama }}"
                data-email="{{ vendor.email }}"
                data-status="{{ vendor.status }}"
                data-metric1="{{ vendor.jumlah_jasa }} listing"
                data-metric2="{{  vendor.rating }} Rating"
                data-metric3="Terakhir aktif: hari ini (dummy)"
              >
                Detail
              </button>
              {% if vendor.status == 'Aktif' %}
                <button type="button" 
                        class="btn btn-warning btn-dashboard btn-status js-user-status"
                        data-url="{% url 'update_status_user' %}"
                        data-id="{{ vendor.id_vendor }}"
                        data-role="Vendor"
                        data-status="Diblokir"
                        data-is_deleted="{{ vendor.is_deleted }}"
                        {% if vendor.is_deleted %} disabled {% endif %}>
                    Blokir
                </button>
              {% else %}
                <button type="button" 
                        class="btn btn-success btn-dashboard btn-status js-user-status"
                        data-url="{% url 'update_status_user' %}"
                        data-id="{{ vendor.id_vendor }}"
                        data-role="Vendor"
                        data-status="Aktif"
                        data-is_deleted="{{ vendor.is_deleted }}"
                        {% if vendor.is_deleted %} disabled {% endif %}>
                    Buka Blokir
                </button>
              {% endif %}

              <button type="button" 
                      class="btn btn-danger btn-dashboard btn-delete js-user-status"
                      data-url="{% url 'update_status_user' %}"
                      data-id="{{ vendor.id_vendor }}"
                      data-role="Vendor"
                      data-status="{{ vendor.status }}"
                      data-is_deleted="{{ vendor.is_deleted }}">
                {% if vendor.is_deleted %} Pulihkan
                {% else %} Hapus 
                {% endif %}
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h5 class="mb-3">Customer</h5>
    <div class="cart-table-wrap">
      <table class="table table-dashboard">
        <thead style="background:#f6f6f6;">
          <tr>
            <th>Nama</th>
            <th>Email</th>
            <th>Total Transaksi</th>
            <th>Status</th>
            <th style="min-width:260px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for customer in list_customer %}
          <tr>
            <td>{{ customer.nama }}</td>
            <td>{{ customer.email }}</td>
            <td>{{ customer.jumlah_transaksi }}</td>
            <td>
              <span id="badge-customer-{{ customer.idcustomer }}" class="badge-status 
                      {% if customer.status == 'Aktif' %} badge-published
                      {% elif customer.status == 'Diblokir' %} badge-unpublished 
                      {% else %} badge-takedown {% endif %}">
                {{ customer.status }}
              </span>
            <td>
              <button
                type="button"
                class="btn btn-primary btn-dashboard btn-detail js-user-detail"
                data-toggle="modal"
                data-target="#modalUserDetail"
                data-role="Customer"
                data-id="{{ customer.idcustomer }}"
                data-name="{{ customer.nama }}"
                data-email="{{ customer.email }}"
                data-status="{{ customer.status }}"
                data-metric1="{{ customer.jumlah_transaksi }} transaksi"
                data-metric2="Komplain: 0 (dummy)"
                data-metric3="Terakhir transaksi: kemarin (dummy)"
              >
                Detail
              </button>
              {% if customer.status == 'Aktif' %}
                  <button type="button" 
                          class="btn btn-warning btn-dashboard btn-status js-user-status"
                          data-url="{% url 'update_status_user' %}"
                          data-id="{{ customer.idcustomer }}"
                          data-role="Customer"
                          data-status="Diblokir"
                          data-is_deleted="{{ customer.is_deleted }}"
                          {% if customer.is_deleted %} disabled {% endif %}>
                      Blokir
                  </button>
              {% else %}
                <button type="button" 
                        class="btn btn-success btn-dashboard btn-status js-user-status"
                        data-url="{% url 'update_status_user' %}"
                        data-id="{{ customer.idcustomer }}"
                        data-role="Customer"
                        data-status="Aktif"
                        data-is_deleted="{{ customer.is_deleted }}"
                        {% if customer.is_deleted %} disabled {% endif %}>
                    Buka Blokir
                </button>
              {% endif %}

              <button type="button" 
                      class="btn btn-danger btn-dashboard btn-delete js-user-status"
                      data-url="{% url 'update_status_user' %}"
                      data-id="{{ customer.idcustomer }}"
                      data-role="Customer"
                      data-status="{{ customer.status }}"
                      data-is_deleted="{{ customer.is_deleted }}">
                  {% if customer.is_deleted %} Pulihkan
                  {% else %} Hapus 
                  {% endif %}
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- 3. RIWAYAT PEMBAYARAN -->
<div class="cart-section mb-150">
  <div class="container">

    <h2 class="section-title-small mb-4">Riwayat Pembayaran & Transaksi</h2>
    <p class="mb-4" style="color:#666;">
      Walau customer diarahkan ke WhatsApp seller, admin bisa menyimpan <b>log transaksi</b>:
      siapa customer, siapa seller, jasa apa, total, dan statusnya (misal: menunggu/selesai).
    </p>

    <div class="cart-table-wrap">
      <table class="table table-dashboard">
        <thead style="background:#f6f6f6;">
          <tr>
            <th>ID Transaksi</th>
            <th>Tanggal</th>
            <th>Customer</th>
            <th>Seller</th>
            <th>Jasa</th>
            <th>Total</th>
            <th>Status</th>
            <th>Catatan</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in transactions_data %}
          <tr>
            <td>{{ transaction.no_transaksi }}</td>
            <td>{{ transaction.tanggal|date:"d/m/Y"}}</td>
            <td>{{ transaction.customer_id_customer.nama }}</td>
            <td>{{ transaction.jasa_id_jasa.vendor_id_vendor.nama }}</td>
            <td>{{ transaction.jasa_id_jasa.name_jasa }}</td>
            <td>Rp {{ transaction.nominal|intcomma }}</td>
            <td><span class="badge-status 
              {% if transaction.payment.status == 'Selesai' %} badge-selesai 
              {% elif transaction.payment.status == 'Menunggu' %} badge-menunggu 
              {% else %} badge-dibatalkan {% endif %}">
                {{ transaction.payment.status }}
              </span></td>
            <td>{{ transaction.deskripsi }}</td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- ========================= -->
<!-- MODAL: EDIT LISTING -->
<!-- ========================= -->
<div class="modal fade" id="modalEditListing" tabindex="-1" role="dialog" aria-labelledby="modalEditListingLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="modalEditListingLabel">Edit Listing</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      
      <form action="{% url 'update_listing_jasa' %}" method="POST">
        {% csrf_token %}

        <input type="hidden" id="editListingIdHidden" name="id_jasa">

        <div class="modal-body">
          <div style="margin-bottom:10px;color:#666;">
            <b>ID:</b> <span id="editListingIdText">-</span> &nbsp;|&nbsp;
            <b>Seller:</b> <span id="editListingSellerText">-</span>
          </div>

          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">Nama Jasa</label>
              <input name="name_jasa" id="editListingName" type="text" class="form-control" placeholder="Nama jasa" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Status</label>
              <select name="status" id="editListingStatus" class="form-control" >
                <option value="Published">Published</option>
                <option value="Unpublished">Unpublished</option>
                <option value="Taken Down">Taken Down</option>
              </select>
              <div class="form-help">Status menentukan apakah tampil di katalog atau tidak.</div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Harga (Rp)</label>
              <input name="harga" id="editListingPrice" type="number" class="form-control" placeholder="contoh: 50000" required>
            </div>
            {% comment %} <div class="col-md-6 mb-3">
              <label class="form-label">Stock</label>
              <input id="editListingStock" type="number" class="form-control" placeholder="contoh: 10">
            </div> {% endcomment %}
          </div>

          <div class="mb-3">
            <label class="form-label">Deskripsi Jasa</label>
            <textarea name="deskripsi" id="editListingDeskripsi" class="form-control" rows="4" placeholder="Deskripsi Jasa..."></textarea>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-dashboard" data-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary btn-dashboard">Simpan Perubahan</button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- ========================= -->
<!-- MODAL: TAKE DOWN CONFIRM -->
<!-- ========================= -->
<div class="modal fade" id="modalTakeDown" tabindex="-1" role="dialog" aria-labelledby="modalTakeDownLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="modalTakeDownLabel">Konfirmasi Take Down</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <p style="margin-bottom:8px;">
          Kamu akan melakukan <b>take down</b> untuk listing:
        </p>
        <div style="color:#2c2c7c;font-weight:700;">
          <span id="tdName">-</span>
        </div>
        <div style="color:#666;margin-top:4px;">
          ID: <span id="tdId"></span> | Seller: <span id="tdSeller">-</span>
        </div>

        <div class="mt-3">
          <label class="form-label">Alasan Take Down (Dummy)</label>
          <textarea class="form-control" rows="3" placeholder="Misal: spam/penipuan/deskripsi menyesatkan/dll"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-dashboard" data-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger btn-dashboard confirm-takedown js-jasa-status" data-dismiss="modal" data-status='Taken Down'>Take Down</button>
      </div>

    </div>
  </div>
</div>

<!-- ========================= -->
<!-- MODAL: USER DETAIL -->
<!-- ========================= -->
<div class="modal fade" id="modalUserDetail" tabindex="-1" role="dialog" aria-labelledby="modalUserDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="modalUserDetailLabel">Detail User</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-md-8">
            <h4 style="margin-bottom:8px;color:#2c2c7c;font-weight:800;">
              <span id="udName">-</span>
            </h4>
            <div style="color:#666;">
              <b>Role:</b> <span id="udRole">-</span><br>
              <b>Email:</b> <span id="udEmail">-</span><br>
              <b>Status:</b> <span id="udStatus">-</span>
            </div>
          </div>

          <div class="col-md-4">
            <div style="background:#f7f7f7;border-radius:12px;padding:14px;">
              <div style="font-weight:700;margin-bottom:10px;color:#2c2c7c;">Ringkasan</div>
              <div style="color:#555;">
                • <span id="udMetric1">-</span><br>
                • <span id="udMetric2">-</span><br>
                • <span id="udMetric3">-</span>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <h5 style="font-weight:700;color:#2c2c7c;">Aksi Admin</h5>
        <p style="color:#666;margin-top:-6px;">
          Ini masih template. Nanti bisa dihubungkan ke backend untuk suspend/blokir/hapus user.
        </p>

        <div class="d-flex flex-wrap" style="gap:10px;">
          <button type="button" class="btn btn-success btn-dashboard">Aktifkan</button>
          <button type="button" class="btn btn-warning btn-dashboard">Suspend / Blokir</button>
          <button type="button" class="btn btn-danger btn-dashboard">Hapus</button>
        </div>

        <div class="form-help">
          Untuk Seller: bisa tambahkan fitur verifikasi/approve. Untuk Customer: bisa simpan riwayat laporan/komplain.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-dashboard" data-dismiss="modal">Tutup</button>
      </div>

    </div>
  </div>
</div>

<!-- ========================= -->
<!-- JS: isi modal dari data-* -->
<!-- ========================= -->
<script>
  // Edit listing
  $(document).on("click", ".js-edit-listing", function () {
    // 1. Ambil data dari tombol yang diklik
    const id = $(this).data("id");
    const name = $(this).data("name");
    const seller = $(this).data("seller");
    const price = $(this).data("price");
    const status = $(this).data("status");
    const deskripsi = $(this).data("deskripsi");
    console.log(id, name, seller, price, status, deskripsi);


    // 2. Masukkan ke Input Form (agar bisa diedit & disubmit)
    $("#editListingIdHidden").val(id); // Masuk ke input hidden
    $("#editListingName").val(name);
    $("#editListingPrice").val(price);
    $("#editListingStatus").val(status);
    $("#editListingDeskripsi").val(deskripsi);

    // 3. Masukkan ke Teks Info (hanya baca)
    $("#editListingIdText").text(id);
    $("#editListingSellerText").text(seller);
  });    

  // Take down confirm
  $(document).on("click", ".js-takedown", function () {
    const id = $(this).data("id");
    const name = $(this).data("name");
    const seller = $(this).data("seller");

    $("#tdId").text(id || "-");
    $("#tdName").text(name || "-");
    $("#tdSeller").text(seller || "-");

    // Update tombol konfirmasi take down dengan data yang sesuai
    $(".confirm-takedown").data("id", id).data("url", $(this).data("url") );
  });

  // User detail
  $(document).on("click", ".js-user-detail", function () {
    $("#udRole").text($(this).data("role") || "-");
    $("#udName").text($(this).data("name") || "-");
    $("#udEmail").text($(this).data("email") || "-");
    $("#udStatus").text($(this).data("status") || "-");

    $("#udMetric1").text($(this).data("metric1") || "-");
    $("#udMetric2").text($(this).data("metric2") || "-");
    $("#udMetric3").text($(this).data("metric3") || "-");
  });


  // --- 1. CSRF Token Helper ---
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // --- 2. Generic Helper Function (Jantung AJAX) ---
  function sendStatusUpdate(url, payload, btnElement, onSuccess) {
      // Efek Loading
      const originalText = btnElement.text();
      btnElement.text("Wait...").prop("disabled", true);

      fetch(url, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken
          },
          body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        console.log("Response:", data);
        if (data.success) {
            onSuccess(data); // Panggil callback UI khusus
        } else {
          alert("Gagal: " + data.message);
          btnElement.text(originalText);
        }
        })
      .catch(error => {
        console.error("Error:", error);
        alert("Terjadi kesalahan koneksi.");
        btnElement.text(originalText);
      })
      .finally(() => {
        // Restore tombol jika masih ada di DOM dan tidak didisable permanen
        if (btnElement.length && !btnElement.prop("disabled-permanent")) {
            btnElement.prop("disabled", false);
        }
      });
  }

  // --- 3. Handler JASA (UI Logic) ---
  $(document).on("click", ".js-jasa-status", function () {
      const btn = $(this);
      const url = btn.data("url");
      const id = btn.data("id");
      const targetStatus = btn.data("status");
      
      sendStatusUpdate(url, {
          id: id,
          status: targetStatus
      }, btn, function(data) {
          // Update Badge
          const badge = $("#badge-jasa-" + id);
          badge.text(data.new_status);
          badge.removeClass("badge-published badge-unpublished badge-takedown");
          
          if (data.new_status === "Published") {
              badge.addClass("badge-published");
          } else if (data.new_status === "Unpublished") {
              badge.addClass("badge-unpublished");
          } else if (data.new_status === "Taken Down") {
              badge.addClass("badge-takedown");
          }

          // Update Tombol (Swap Warna & Fungsi)
          if (targetStatus === "Published") {
              // Sekarang sudah Published, tombol harus jadi "Unpublish" (Kuning)
              btn.removeClass("btn-success").addClass("btn-warning");
              btn.text("Unpublish");
              btn.data("status", "Unpublished"); // Update data-status untuk klik berikutnya
          } if (targetStatus === "Unpublished") {
              // Sekarang sudah Unpublished, tombol harus jadi "Publish" (Hijau)
              btn.removeClass("btn-warning").addClass("btn-success");
              btn.text("Publish");
              btn.data("status", "Published");
              $("#actions-cell-" + id).find(".js-takedown").prop("disabled", false); // Enable tombol Take Down kembali
          } else if (targetStatus === "Taken Down") {
              // Tombol Take Down di-disable
              btn.text("Taken Down");
              btn.prop("disabled", true);
              
              // Juga update tombol menjadi unpublish
              const actionsCell = $("#actions-cell-" + id);
              actionsCell.find(".js-takedown").prop("disabled", true);
              actionsCell.find(".js-jasa-status").removeClass("btn-success btn-warning").addClass("btn-warning").text("Unpublish").data("status", "Unpublished");
          }

          $(document).find(".js-edit-listing[data-id='" + btn.data("id") + "']").data("status", data.new_status);
      });
  });

  // --- 4. Handler USER (UI Logic) ---
  $(document).on("click", ".js-user-status", function () {
      const btn = $(this);
      const url = btn.data("url");
      const targetStatus = btn.data("status");
      const isDeleted = btn.data("is_deleted");
      const userRole = btn.data("role");
      const is_delete_action = btn.hasClass("btn-delete");

      // Konfirmasi Hapus
      if (targetStatus === 'Dihapus' && !confirm("Yakin hapus user ini? User tidak akan bisa login lagi.")) {
          return;
      }
      sendStatusUpdate(url, {
          id: btn.data("id"),
          status: targetStatus,
          role: userRole,
          is_delete_action: is_delete_action
      }, btn, function(data) {
        
        // Update Badge
        if(userRole === "Vendor") {
          var badge = $("#badge-vendor-" + btn.data("id"));
        } else {
          var badge = $("#badge-customer-" + btn.data("id"));
        }
        badge.text(data.new_status); 
        badge.removeClass("badge-published badge-unpublished badge-takedown");
        
        // Update Tombol
        if (data.is_deleted) {
          btn.text("Pulihkan").attr("data-is_deleted", true);
          badge.text("Dihapus").addClass("badge-takedown");

          $(document).find(".btn-status[data-id='" + btn.data("id") + "'][data-role='" + userRole + "']").prop("disabled", true).prop("disabled-permanent", true);

        } else {
          if (targetStatus === "Diblokir") {
            // Berubah jadi tombol "Buka Blokir"
            btn.removeClass("btn-warning").addClass("btn-success")
            .attr("data-status", "Aktif").text("Buka Blokir").data("status", "Aktif");
          }
          else if (targetStatus === "Aktif") {
            // Berubah jadi tombol "Blokir"
            btn.removeClass("btn-success").addClass("btn-warning")
            .attr("data-status", "Diblokir").text("Blokir").data("status", "Diblokir");
          }
          
          if ( is_delete_action ) {
            btn.text("Hapus").attr("data-is_deleted", false);
            badge.text(targetStatus);
            $(document).find(".btn-status[data-id='" + btn.data("id") + "'][data-role='" + userRole + "']").prop("disabled", false).prop("disabled-permanent", false);
          } 
          
          if (data.new_status === "Aktif") badge.addClass("badge-published");
          else if (data.new_status === "Diblokir") badge.addClass("badge-unpublished");
          else badge.addClass("badge-takedown");
        }

        $(document).find(".js-user-detail[data-id='" + btn.data("id") + "'][data-role='" + userRole + "']").data("status", data.new_status);
      });
  });
</script>

{% endblock %}
